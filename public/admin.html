<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Console • Moorecoin</title>
    <link rel="stylesheet" href="./styles.css" />
    <link rel="stylesheet" href="./admin.css" />
    <link rel="icon" type="image/png" href="./img/favicon.png" />
    <style>
      /* Lightweight reuse of modal from dashboard to avoid duplication; override if needed. */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(3px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1200;
        animation: fadeIn 0.18s ease;
      }

      .modal {
        background: #1d1f23;
        color: #fafafa;
        border: 1px solid #2e3238;
        border-radius: 14px;
        width: min(560px, 94vw);
        max-height: 82vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow:
          0 6px 30px -6px rgba(0, 0, 0, 0.55),
          0 0 0 1px rgba(255, 255, 255, 0.04) inset;
        animation: scaleIn 0.24s cubic-bezier(0.4, 0.6, 0.3, 1);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }

        to {
          opacity: 1;
        }
      }

      @keyframes scaleIn {
        from {
          transform: scale(0.94) translateY(6px);
          opacity: 0;
        }

        to {
          transform: scale(1) translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        padding: 18px 22px 12px;
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .modal-header h2 {
        font-size: 1.25rem;
        margin: 0;
        font-weight: 600;
        letter-spacing: 0.5px;
      }

      .modal-close {
        margin-left: auto;
        background: transparent;
        border: 0;
        color: #c7cdd6;
        font-size: 1.25rem;
        cursor: pointer;
        line-height: 1;
        padding: 4px 8px;
        border-radius: 8px;
        transition: background 0.15s;
      }

      .modal-close:hover,
      .modal-close:focus-visible {
        background: #2b3138;
        outline: none;
      }

      .modal-body {
        padding: 8px 22px 20px;
        overflow-y: auto;
        scrollbar-width: thin;
      }

      .modal-footer {
        padding: 14px 22px 18px;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        background: linear-gradient(#1d1f23, #181a1d);
        border-top: 1px solid #292d33;
      }

      .modal-footer button {
        border-radius: 10px;
        font-weight: 600;
      }

      .btn-secondary {
        background: #2c3138;
        color: #f5f7fa;
        border: 1px solid #394048;
        padding: 9px 16px;
        cursor: pointer;
      }

      .btn-secondary:hover {
        background: #353b43;
      }

      .btn-primary {
        background: linear-gradient(92deg, #4361ee, #3a86ff);
        color: #fff;
        border: 1px solid #3b5edb;
        padding: 9px 16px;
        cursor: pointer;
      }

      .btn-primary:hover {
        filter: brightness(1.08);
      }

      .btn-secondary.btn-xs {
        padding: 4px 8px;
        font-size: 0.72rem;
        line-height: 1.1;
      }

      /* Banner styles (subset) for preview */
      .site-banner {
        position: relative;
        width: 100%;
        box-sizing: border-box;
        border-radius: 10px;
        overflow: hidden;
      }
      .site-banner-inner {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: center;
        padding: 10px 16px;
        border-bottom: 1px solid transparent;
        font-weight: 600;
        letter-spacing: 0.2px;
      }
      .banner-info {
        background: #22324a;
        color: #d8e6ff;
        border-color: #2a3b56;
      }
      .banner-success {
        background: #153b2b;
        color: #bff3df;
        border-color: #194734;
      }
      .banner-warning {
        background: #3b2f15;
        color: #ffe3b8;
        border-color: #4a3a19;
      }
      .banner-danger {
        background: #3b1b1b;
        color: #ffd5d5;
        border-color: #4a2222;
      }
      .banner-promo {
        background: #241d3b;
        color: #e5d9ff;
        border-color: #2b2247;
      }

      /* Light mode overrides for inline admin components */
      @media (prefers-color-scheme: light) {
        .modal-overlay {
          background: rgba(0, 0, 0, 0.35);
        }
        .modal {
          background: #ffffff;
          color: #111;
          border: 1px solid #e1e5ea;
          box-shadow:
            0 6px 24px -6px rgba(0, 0, 0, 0.2),
            0 0 0 1px rgba(0, 0, 0, 0.02) inset;
        }
        .modal-footer {
          background: linear-gradient(#ffffff, #f6f8fa);
          border-top: 1px solid #e8ecf2;
        }
        .btn-secondary {
          background: #f1f3f6;
          color: #111;
          border-color: #e1e5ea;
        }
        .banner-info {
          background: #e8f1ff;
          color: #2b6cb0;
          border-color: #d6e4ff;
        }
        .banner-success {
          background: #e6fbf2;
          color: #0b7a4e;
          border-color: #c7f5e3;
        }
        .banner-warning {
          background: #fff4e5;
          color: #7a4a0b;
          border-color: #ffe6c7;
        }
        .banner-danger {
          background: #ffe8e8;
          color: #7a0b0b;
          border-color: #ffd1d1;
        }
        .banner-promo {
          background: #efe9ff;
          color: #4a2db0;
          border-color: #e2d6ff;
        }
      }
    </style>
  </head>

  <body class="admin-page">
    <img src="./img/favicon.png" id="logo" alt="Logo" />
    <img
      src="./img/default-profile-picture.svg"
      id="profile-pic"
      alt="Profile"
    />
    <div
      id="profile-menu"
      class="profile-menu hidden"
      role="menu"
      aria-hidden="true"
    >
      <div class="profile-menu-header">
        <img
          id="profile-menu-avatar"
          src="./img/default-profile-picture.svg"
          alt="Profile"
        />
        <div class="profile-menu-text">
          <span id="profile-menu-name">Admin</span>
          <small id="profile-menu-email"></small>
        </div>
      </div>
      <hr />
      <button class="profile-menu-item" id="go-dashboard" role="menuitem">
        Student View
      </button>
      <button class="profile-menu-item" id="sign-out" role="menuitem">
        Sign Out
      </button>
    </div>

    <main id="admin-shell" aria-live="polite">
      <header class="admin-header">
        <h1>Admin Console</h1>
        <div class="section-tabs" role="tablist">
          <button
            role="tab"
            aria-selected="true"
            id="tab-stats"
            data-target="panel-stats"
          >
            General Stats
          </button>
          <button
            role="tab"
            aria-selected="false"
            id="tab-settings"
            data-target="panel-settings"
          >
            Settings
          </button>
          <button
            role="tab"
            aria-selected="false"
            id="tab-users"
            data-target="panel-users"
          >
            Users
          </button>
          <button
            role="tab"
            aria-selected="false"
            id="tab-pending"
            data-target="panel-pending"
          >
            Pending
          </button>
          <button
            role="tab"
            aria-selected="false"
            id="tab-roulette"
            data-target="panel-roulette"
          >
            Roulette
          </button>
          <button
            role="tab"
            aria-selected="false"
            id="tab-feedback"
            data-target="panel-feedback"
          >
            Feedback
          </button>
        </div>
      </header>
      <section
        id="panel-stats"
        class="panel active"
        role="tabpanel"
        aria-labelledby="tab-stats"
      >
        <div class="cards" id="stats-cards">
          <div class="card metric">
            <div class="label">Global Moorecoins</div>
            <div class="value" id="stat-global-coins">--</div>
          </div>
          <div class="card metric">
            <div class="label">Total Users</div>
            <div class="value" id="stat-total-users">--</div>
          </div>
          <div class="card metric">
            <div class="label">Exchange Rate</div>
            <div class="value" id="stat-exchange">--</div>
          </div>
          <div class="card metric">
            <div class="label">2W Bond ROI</div>
            <div class="value" id="stat-interest">--</div>
          </div>
        </div>
        <div class="actions-row">
          <button class="btn-primary" id="btn-adjust-global">
            Adjust Global Coins
          </button>
          <button class="btn-secondary" id="btn-refresh-stats">Refresh</button>
        </div>
        <p class="inline-info" id="stats-status" aria-live="polite"></p>
      </section>
      <section
        id="panel-feedback"
        class="panel"
        role="tabpanel"
        aria-labelledby="tab-feedback"
        hidden
      >
        <div class="cards" style="gap: 10px; align-items: flex-start">
          <div class="card" style="flex: 1 1 680px">
            <h2 style="margin-top: 0">User Feedback</h2>
            <div
              style="
                display: flex;
                gap: 10px;
                align-items: center;
                margin: 8px 0 10px;
              "
            >
              <input
                id="feedback-search"
                type="search"
                placeholder="Search subject/message/email…"
                aria-label="Search feedback"
                style="flex: 1; min-width: 240px"
              />
              <select id="feedback-filter" aria-label="Filter category">
                <option value="">All categories</option>
                <option value="general">General</option>
                <option value="bug">Bug</option>
                <option value="feature">Feature</option>
                <option value="ui">Design/UI</option>
              </select>
              <select id="feedback-status-filter" aria-label="Filter status">
                <option value="">All status</option>
                <option value="new">New</option>
                <option value="reviewed">Reviewed</option>
                <option value="closed">Closed</option>
                <option value="spam">Spam</option>
              </select>
            </div>
            <div style="overflow: auto">
              <table class="table" style="min-width: 760px">
                <thead>
                  <tr>
                    <th style="width: 120px">When</th>
                    <th style="width: 80px">Category</th>
                    <th style="width: 70px">Rating</th>
                    <th style="width: 160px">User</th>
                    <th>Subject / Message</th>
                    <th style="width: 160px">Actions</th>
                  </tr>
                </thead>
                <tbody id="feedback-tbody">
                  <tr>
                    <td colspan="6" style="text-align: center; opacity: 0.7">
                      Loading…
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <p id="feedback-status" class="inline-info" aria-live="polite"></p>
          </div>
        </div>
      </section>
      <section
        id="panel-settings"
        class="panel"
        role="tabpanel"
        aria-labelledby="tab-settings"
        hidden
      >
        <h2>Settings</h2>
        <p class="inline-info">
          Feature scaffold - future administrative toggles & bond parameters
          will appear here.
        </p>
        <div class="card" style="max-width: 680px; margin-bottom: 16px">
          <h3
            style="margin-top: 0; display: flex; align-items: center; gap: 8px"
          >
            Site Banner <span class="chip">beta</span>
          </h3>
          <div class="form-row">
            <label for="banner-msg">Message</label>
            <textarea
              id="banner-msg"
              rows="3"
              style="
                width: 100%;
                background: #23262b;
                border: 1px solid #30343a;
                padding: 10px 12px;
                border-radius: 10px;
                color: #f2f6fa;
                resize: vertical;
              "
              placeholder="e.g. Find a bug, earn 50 Moorecoins"
            ></textarea>
          </div>
          <div class="form-row">
            <label for="banner-link">Link (optional)</label>
            <input
              id="banner-link"
              type="url"
              placeholder="https://example.com/details"
              style="
                width: 100%;
                background: #23262b;
                border: 1px solid #30343a;
                padding: 10px 12px;
                border-radius: 10px;
                color: #f2f6fa;
              "
            />
          </div>
          <div class="two-col" style="margin: 10px 0 6px">
            <div class="form-row">
              <label for="banner-variant">Variant</label>
              <select
                id="banner-variant"
                style="
                  width: 100%;
                  background: #23262b;
                  border: 1px solid #30343a;
                  padding: 10px 12px;
                  border-radius: 10px;
                  color: #f2f6fa;
                "
              >
                <option value="promo">Promo (purple)</option>
                <option value="info">Info (blue)</option>
                <option value="success">Success (green)</option>
                <option value="warning">Warning (amber)</option>
                <option value="danger">Danger (red)</option>
              </select>
            </div>
            <div
              class="form-row"
              style="display: flex; align-items: center; gap: 14px"
            >
              <label style="display: flex; align-items: center; gap: 8px">
                <input id="banner-active" type="checkbox" checked /> Active
              </label>
              <label style="display: flex; align-items: center; gap: 8px">
                <input id="banner-dismissible" type="checkbox" checked />
                Dismissible
              </label>
            </div>
          </div>
          <div class="inline-info">
            Saving will bump the version so students see the updated banner even
            if previously dismissed.
          </div>
          <div
            style="display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap"
          >
            <button class="btn-secondary" id="banner-preview">Preview</button>
            <button class="btn-primary" id="banner-save">Save Banner</button>
            <button
              class="btn-secondary"
              id="banner-deactivate"
              title="Turn off banner"
              style="background: #3a1f1f; border-color: #5a2b2b"
            >
              Deactivate
            </button>
            <button
              class="btn-secondary"
              id="banner-reset"
              title="Only affects your browser"
            >
              Reset My Dismiss
            </button>
          </div>
          <div
            id="banner-status"
            class="inline-info"
            style="min-height: 16px; margin-top: 8px"
          ></div>
          <div id="banner-preview-area" style="margin-top: 10px"></div>
        </div>
        <div class="card" style="max-width: 480px">
          <h3 style="margin-top: 0">Planned Controls</h3>
          <ul class="planned">
            <li>Set base exchange decay coefficients</li>
            <li>Adjust default starting balance</li>
            <li>Toggle casino access</li>
          </ul>
        </div>
      </section>
      <section
        id="panel-users"
        class="panel"
        role="tabpanel"
        aria-labelledby="tab-users"
        hidden
      >
        <div class="users-header">
          <h2>Users</h2>
          <div class="users-actions">
            <input
              type="search"
              id="user-search"
              placeholder="Search name/email"
              aria-label="Search users"
            />
            <select id="user-sort" aria-label="Sort field" title="Sort field">
              <option value="coins">Coins</option>
              <option value="totalEarned">Total Earned</option>
              <option value="createdAt">Created</option>
              <option value="name">Name</option>
            </select>
            <button
              class="btn-secondary"
              id="btn-sort-dir"
              data-dir="desc"
              title="Toggle sort direction"
            >
              Desc ↓
            </button>
            <button
              class="btn-secondary"
              id="btn-reload-users"
              title="Reload list"
            >
              Reload
            </button>
            <button
              class="btn-primary"
              id="btn-hour-award"
              title="Award coins to an hour"
              style="
                background: linear-gradient(92deg, #ff914d, #ff6000);
                border-color: #ff7a2b;
              "
            >
              Award Hour
            </button>
          </div>
        </div>
        <div class="table-wrap" tabindex="0">
          <table id="users-table" aria-describedby="users-caption">
            <caption id="users-caption">
              Current users
            </caption>
            <thead>
              <tr>
                <th>Avatar</th>
                <th>Name</th>
                <th>Email</th>
                <th>Coins</th>
                <th>Total Earned</th>
                <th>Hour</th>
                <th>Admin</th>
              </tr>
            </thead>
            <tbody id="users-tbody">
              <tr>
                <td colspan="6" style="text-align: center; opacity: 0.7">
                  Loading…
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="inline-info" id="users-status" aria-live="polite"></p>
      </section>
      <section
        id="panel-pending"
        class="panel"
        role="tabpanel"
        aria-labelledby="tab-pending"
        hidden
      >
        <div class="users-header">
          <h2>Pending Transactions</h2>
          <div class="users-actions">
            <button
              class="btn-secondary"
              id="btn-reload-pending"
              title="Reload pending list"
            >
              Reload
            </button>
          </div>
        </div>
        <div class="table-wrap" tabindex="0">
          <table id="pending-table" aria-describedby="pending-caption">
            <caption id="pending-caption">
              Pending exchanges awaiting conversion to extra credit
            </caption>
            <thead>
              <tr>
                <th>User</th>
                <th>Email</th>
                <th>Coins</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="pending-tbody">
              <tr>
                <td colspan="4" style="text-align: center; opacity: 0.7">
                  Loading…
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="inline-info" id="pending-status" aria-live="polite"></p>
      </section>

      <!-- Roulette Panel -->
      <section
        id="panel-roulette"
        class="panel"
        role="tabpanel"
        aria-labelledby="tab-roulette"
        hidden
      >
        <div
          class="users-header"
          style="align-items: flex-start; gap: 14px; flex-wrap: wrap"
        >
          <h2 style="margin-top: 6px">Roulette</h2>
          <div class="users-actions" style="flex-wrap: wrap; gap: 10px">
            <button class="btn-secondary" id="roulette-load">
              Reload Config
            </button>
            <button class="btn-primary" id="roulette-save">Save Config</button>
            <button
              class="btn-secondary"
              id="roulette-reset"
              title="Reset to simple defaults"
            >
              Reset
            </button>
          </div>
        </div>
        <div
          class="card"
          style="
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 16px;
            align-items: stretch;
          "
        >
          <div
            class="roulette-stage"
            style="
              display: flex;
              flex-direction: column;
              gap: 10px;
              position: relative;
            "
          >
            <canvas
              id="roulette-canvas"
              width="320"
              height="320"
              style="
                background: #121418;
                border: 1px solid #2e3238;
                border-radius: 12px;
                width: 100%;
                height: auto;
              "
            ></canvas>
            <div
              id="roulette-confetti"
              class="confetti-layer"
              aria-hidden="true"
            ></div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap">
              <button class="btn-primary" id="roulette-spin">Spin</button>
              <button class="btn-secondary" id="roulette-apply">
                Apply Result
              </button>
              <span
                id="roulette-result"
                class="value-chip result-badge"
                style="display: none"
              ></span>
            </div>
          </div>
          <div>
            <h3 style="margin-top: 0">Wheel Configuration</h3>
            <div class="two-col" style="grid-template-columns: 1fr 1fr">
              <div class="form-row">
                <label for="roulette-entry">Entry Cost (coins)</label>
                <input
                  id="roulette-entry"
                  type="number"
                  min="0"
                  step="1"
                  value="1"
                />
              </div>
              <div
                class="form-row"
                style="display: flex; align-items: center; gap: 8px"
              >
                <label
                  style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    margin: 0;
                  "
                >
                  <input id="roulette-clamp" type="checkbox" checked /> Prevent
                  negative balances
                </label>
              </div>
              <div
                class="form-row"
                style="display: flex; align-items: center; gap: 8px"
              >
                <label
                  style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    margin: 0;
                  "
                >
                  <input id="roulette-effects" type="checkbox" checked />
                  Celebration effects (sound & confetti)
                </label>
              </div>
            </div>
            <div class="form-row">
              <label>Segments</label>
              <div id="roulette-segments"></div>
              <div style="display: flex; gap: 8px; margin-top: 8px">
                <button class="btn-secondary" id="segment-add">
                  Add Segment
                </button>
                <button class="btn-secondary" id="segment-balance">
                  Normalize Weights
                </button>
              </div>
              <div class="inline-info">
                Each segment has a label (display), delta (coins added or
                removed), color, and weight (relative odds). Example: label
                "+5", delta 5, weight 3.
              </div>
            </div>
          </div>
        </div>

        <!-- Odds & Simulator -->
        <div class="card" style="margin-top: 16px">
          <h3 style="margin-top: 0">Odds & Simulator</h3>
          <div class="stats-grid" id="odds-stats">
            <div class="stat-box">
              <div class="label">Win Probability</div>
              <div class="value" id="stat-pwin">--%</div>
            </div>
            <div class="stat-box">
              <div class="label">Loss Probability</div>
              <div class="value" id="stat-ploss">--%</div>
            </div>
            <div class="stat-box">
              <div class="label">Zero Delta</div>
              <div class="value" id="stat-pzero">--%</div>
            </div>
            <div class="stat-box">
              <div class="label">Expected Δ per Spin</div>
              <div class="value" id="stat-ev">--</div>
            </div>
            <div class="stat-box">
              <div class="label">House Edge (vs entry)</div>
              <div class="value" id="stat-house">--%</div>
            </div>
          </div>
          <div class="form-row">
            <label>Segment Probabilities</label>
            <div class="prob-list" id="prob-list"></div>
          </div>
          <hr />
          <h4 style="margin: 0 0 6px">Monte Carlo Simulation</h4>
          <div class="sim-controls">
            <div class="form-row">
              <label for="sim-trials">Trials</label>
              <input
                id="sim-trials"
                type="number"
                min="100"
                step="100"
                value="2000"
              />
            </div>
            <div class="form-row">
              <label for="sim-steps">Spins per Trial</label>
              <input id="sim-steps" type="number" min="1" step="1" value="50" />
            </div>
            <div class="form-row">
              <label for="sim-bankroll">Starting Bankroll (coins)</label>
              <input
                id="sim-bankroll"
                type="number"
                min="0"
                step="1"
                value="100"
              />
            </div>
            <div class="form-row">
              <label for="sim-entry">Entry Cost Override (optional)</label>
              <input
                id="sim-entry"
                type="number"
                min="0"
                step="1"
                placeholder="(use wheel entry)"
              />
            </div>
          </div>
          <div class="sim-actions">
            <button class="btn-primary" id="sim-run">Run Simulation</button>
            <button class="btn-secondary" id="sim-stop" disabled>Stop</button>
          </div>
          <p class="sim-status" id="sim-status" aria-live="polite"></p>
          <div class="stats-grid">
            <div class="stat-box">
              <div class="label">Median Profit</div>
              <div class="value" id="sim-med">--</div>
            </div>
            <div class="stat-box">
              <div class="label">Mean Profit</div>
              <div class="value" id="sim-mean">--</div>
            </div>
            <div class="stat-box">
              <div class="label">Best 5%</div>
              <div class="value" id="sim-p95">--</div>
            </div>
            <div class="stat-box">
              <div class="label">Worst 5%</div>
              <div class="value" id="sim-p05">--</div>
            </div>
            <div class="stat-box">
              <div class="label">Bust Probability</div>
              <div class="value" id="sim-bust">--%</div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top: 16px">
          <h3 style="margin-top: 0">Participants</h3>
          <div class="users-actions" style="gap: 8px; flex-wrap: wrap">
            <input
              type="search"
              id="roulette-search"
              placeholder="Search name/email"
              aria-label="Search participants"
            />
            <select id="roulette-hour" aria-label="Filter by hour">
              <option value="">All Hours</option>
              <option value="1">Hour 1</option>
              <option value="2">Hour 2</option>
              <option value="3">Hour 3</option>
              <option value="4">Hour 4</option>
              <option value="5">Hour 5</option>
              <option value="6">Hour 6</option>
              <option value="none">No hour</option>
            </select>
            <button class="btn-secondary" id="roulette-reload">
              Reload Users
            </button>
            <button class="btn-secondary" id="select-all">Select All</button>
            <button class="btn-secondary" id="select-none">Select None</button>
          </div>
          <div
            class="table-wrap"
            tabindex="0"
            style="max-height: 320px; overflow: auto"
          >
            <table
              id="roulette-users"
              aria-describedby="roulette-users-caption"
            >
              <caption id="roulette-users-caption">
                Select students to include in the spin result application.
              </caption>
              <thead>
                <tr>
                  <th style="width: 34px"></th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Coins</th>
                  <th>Hour</th>
                </tr>
              </thead>
              <tbody id="roulette-users-tbody">
                <tr>
                  <td colspan="5" style="text-align: center; opacity: 0.7">
                    Load users…
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <p class="inline-info" id="roulette-users-status"></p>
        </div>
      </section>
    </main>

    <footer>
      <div id="footer-content">
        <a href="https://github.com/moorecoin-bhs/Moorecoin" target="_blank"
          >Source Code</a
        >
      </div>
    </footer>

    <script type="module">
      import {
        app,
        apiBase,
        calculateExchangeRate,
        calculateInterestRate,
      } from "./app.js?v=1";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
      import {
        getFirestore,
        doc,
        onSnapshot,
        getDoc,
        setDoc,
        serverTimestamp,
        collection,
        query,
        orderBy,
        limit,
        updateDoc,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
      const auth = getAuth(app);
      let currentIdToken = null;

      const DEFAULT_AVATAR = "./img/default-profile-picture.svg";
      function safeSetAvatar(img, url) {
        if (!img) return;
        img.referrerPolicy = "no-referrer";
        img.decoding = "async";
        img.loading = "lazy";
        img.onerror = () => {
          if (img.src !== DEFAULT_AVATAR) {
            img.src = DEFAULT_AVATAR;
          }
        };
        if (!url) {
          img.src = DEFAULT_AVATAR;
          return;
        }
        // Avoid re-request if already same
        if (img.dataset.originalSrc === url) return;
        img.dataset.originalSrc = url;
        img.src = url;
      }

      // Modal factory (trimmed variant from dashboard)
      let openModalRef = null;
      function createModal({ title, body, actions = [], initialFocus }) {
        if (openModalRef) openModalRef.close();
        const overlay = document.createElement("div");
        overlay.className = "modal-overlay";
        const dialog = document.createElement("div");
        dialog.className = "modal";
        dialog.setAttribute("role", "dialog");
        dialog.setAttribute("aria-modal", "true");
        const header = document.createElement("div");
        header.className = "modal-header";
        const h2 = document.createElement("h2");
        h2.textContent = title;
        header.append(h2);
        const closeBtn = document.createElement("button");
        closeBtn.className = "modal-close";
        closeBtn.innerHTML = "&times;";
        closeBtn.addEventListener("click", () => close());
        header.append(closeBtn);
        const bodyWrap = document.createElement("div");
        bodyWrap.className = "modal-body";
        if (typeof body === "string") bodyWrap.innerHTML = body;
        else bodyWrap.append(body);
        const footer = document.createElement("div");
        footer.className = "modal-footer";
        if (!actions.length) {
          const b = document.createElement("button");
          b.textContent = "Close";
          b.className = "btn-secondary";
          b.onclick = () => close();
          footer.append(b);
        } else {
          actions.forEach((cfg) => {
            const b = document.createElement("button");
            b.textContent = cfg.label;
            b.className = cfg.primary ? "btn-primary" : "btn-secondary";
            b.type = cfg.type || "button";
            b.onclick = () =>
              cfg.onClick?.({ close }) !== false &&
              cfg.closeOnClick !== false &&
              close();
            footer.append(b);
          });
        }
        dialog.append(header, bodyWrap, footer);
        overlay.append(dialog);
        function close() {
          overlay.remove();
          openModalRef = null;
        }
        document.body.append(overlay);
        setTimeout(() => {
          (initialFocus
            ? dialog.querySelector(initialFocus)
            : dialog.querySelector("button")
          )?.focus();
        }, 20);
        openModalRef = { close, overlay, dialog };
        return openModalRef;
      }

      // Tab logic
      const tabs = Array.from(
        document.querySelectorAll(".section-tabs [role=tab]"),
      );
      function activateTab(btn) {
        if (!btn) return;
        tabs.forEach((t) => {
          const panelId = t.dataset.target;
          const panel = document.getElementById(panelId);
          const active = t === btn;
          t.setAttribute("aria-selected", String(active));
          if (panel) {
            if (active) {
              panel.classList.add("active");
              panel.removeAttribute("hidden");
              if (panelId === "panel-pending") {
                loadPending();
              } else if (panelId === "panel-roulette") {
                // Lazy-load config and participants when opening Roulette
                loadRouletteConfig();
                loadRouletteUsers();
                drawRoulette();
              } else if (panelId === "panel-feedback") {
                startFeedbackStream();
              }
            } else {
              panel.classList.remove("active");
              panel.setAttribute("hidden", "");
            }
          }
        });
        btn.focus();
      }
      tabs.forEach((t) => t.addEventListener("click", () => activateTab(t)));
      document.addEventListener("keydown", (e) => {
        if (e.key === "ArrowRight" || e.key === "ArrowLeft") {
          const i = tabs.indexOf(document.activeElement);
          if (i > -1) {
            const dir = e.key === "ArrowRight" ? 1 : -1;
            let ni = (i + dir + tabs.length) % tabs.length;
            activateTab(tabs[ni]);
          }
        }
      });

      // -----------------
      // Roulette helpers
      // -----------------
      const R_DEFAULT = {
        entryCost: 1,
        clampNoNegative: true,
        segments: [
          { label: "+5", delta: 5, color: "#2b9348", weight: 2 },
          { label: "+2", delta: 2, color: "#55a630", weight: 3 },
          { label: "-2", delta: -2, color: "#d90429", weight: 3 },
          { label: "0", delta: 0, color: "#6c757d", weight: 2 },
        ],
        updatedAt: null,
        updatedBy: null,
      };
      let rouletteCfg = structuredClone(R_DEFAULT);
      let rouletteSpinResult = null; // {index, segment}
      let rouletteEffectsEnabled = true;

      // --- Lightweight audio helpers (WebAudio; no external assets) ---
      let audioCtx = null;
      function ensureAudio() {
        if (!rouletteEffectsEnabled) return null;
        try {
          if (!audioCtx)
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          if (audioCtx.state === "suspended") audioCtx.resume();
          return audioCtx;
        } catch (_) {
          return null;
        }
      }
      function beep({
        freq = 800,
        time = 0.04,
        type = "square",
        volume = 0.07,
      }) {
        const ctx = ensureAudio();
        if (!ctx) return;
        const t0 = ctx.currentTime;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(volume, t0);
        gain.gain.exponentialRampToValueAtTime(0.0001, t0 + time);
        osc.connect(gain).connect(ctx.destination);
        osc.start();
        osc.stop(t0 + time + 0.02);
      }
      function playTick(intensity = 1) {
        const f = 650 + 250 * intensity;
        const vol = 0.03 + 0.04 * intensity;
        beep({ freq: f, time: 0.03, type: "square", volume: vol });
      }
      function playWin() {
        const ctx = ensureAudio();
        if (!ctx) return;
        [880, 1175, 1568].forEach((f, i) =>
          setTimeout(
            () => beep({ freq: f, time: 0.08, type: "sine", volume: 0.08 }),
            i * 90,
          ),
        );
      }
      function playLose() {
        const ctx = ensureAudio();
        if (!ctx) return;
        [440, 330].forEach((f, i) =>
          setTimeout(
            () => beep({ freq: f, time: 0.1, type: "triangle", volume: 0.06 }),
            i * 120,
          ),
        );
      }

      // --- Confetti & stage effects ---
      function fireConfetti({ count = 80 } = {}) {
        if (!rouletteEffectsEnabled) return;
        const layer = document.getElementById("roulette-confetti");
        if (!layer) return;
        if (
          window.matchMedia &&
          window.matchMedia("(prefers-reduced-motion: reduce)").matches
        )
          return;
        const rect = layer.getBoundingClientRect();
        const width = rect.width || 320;
        const height = rect.height || 320;
        const colors = [
          "#ffbe0b",
          "#fb5607",
          "#ff006e",
          "#8338ec",
          "#3a86ff",
          "#2b9348",
        ];
        for (let i = 0; i < count; i++) {
          const s = document.createElement("div");
          s.className = "confetti-piece";
          const size = 6 + Math.random() * 6;
          s.style.width = `${size}px`;
          s.style.height = `${size * (0.5 + Math.random())}px`;
          s.style.left = `${10 + Math.random() * 80}%`;
          s.style.background = colors[i % colors.length];
          // Compute drift in pixels for consistent travel distance
          const tx = (-0.4 + Math.random() * 0.8) * width; // -40%..40% of layer width
          const ty = height * (1.15 + Math.random() * 0.2); // fall beyond bottom
          s.style.setProperty("--tx", `${tx}px`);
          s.style.setProperty("--ty", `${ty}px`);
          s.style.setProperty("--rz", `${Math.random() * 720 - 360}deg`);
          const dur = 0.95 + Math.random() * 0.95;
          s.style.animationDuration = `${dur}s`;
          layer.appendChild(s);
          setTimeout(() => s.remove(), Math.ceil(dur * 1000) + 400);
        }
      }
      function shakeStage() {
        const stage = document.querySelector(".roulette-stage");
        if (!stage) return;
        stage.classList.add("shake");
        setTimeout(() => stage.classList.remove("shake"), 500);
      }
      function flashCanvasWin() {
        const c = document.getElementById("roulette-canvas");
        if (!c) return;
        c.classList.add("canvas-glow");
        setTimeout(() => c.classList.remove("canvas-glow"), 600);
      }

      function segRow(seg, idx) {
        const row = document.createElement("div");
        row.style.display = "grid";
        row.style.gridTemplateColumns = "1.4fr .9fr .9fr .9fr 34px";
        row.style.gap = "8px";
        row.style.alignItems = "center";
        row.style.marginBottom = "8px";
        row.innerHTML = `
          <input type="text" data-k="label" placeholder="Label" value="${seg.label || ""}">
          <input type="number" data-k="delta" step="1" placeholder="0" value="${Number(seg.delta || 0)}">
          <input type="color" data-k="color" value="${seg.color || "#888888"}">
          <input type="number" data-k="weight" min="1" step="1" placeholder="1" value="${Number(seg.weight || 1)}">
          <button class="btn-secondary btn-xs" title="Remove">✕</button>`;
        row.querySelector("button").addEventListener("click", () => {
          row.remove();
          applySegFormToModel();
          drawRoulette();
        });
        row.querySelectorAll("input").forEach((inp) => {
          inp.addEventListener("input", () => {
            applySegFormToModel();
            drawRoulette();
          });
        });
        return row;
      }
      function renderSegForm() {
        const host = document.getElementById("roulette-segments");
        if (!host) return;
        host.innerHTML = "";
        rouletteCfg.segments.forEach((s, i) => host.append(segRow(s, i)));
      }
      function applySegFormToModel() {
        const host = document.getElementById("roulette-segments");
        if (!host) return;
        const rows = [...host.children];
        rouletteCfg.segments = rows.map((r) => {
          const get = (sel) => r.querySelector(`[data-k="${sel}"]`);
          return {
            label: get("label").value.trim() || "",
            delta: Number(get("delta").value || 0),
            color: get("color").value || "#888888",
            weight: Math.max(1, Number(get("weight").value || 1)),
          };
        });
        rouletteCfg.entryCost = Number(
          document.getElementById("roulette-entry")?.value || 0,
        );
        rouletteCfg.clampNoNegative =
          !!document.getElementById("roulette-clamp")?.checked;
      }
      function fillFormFromCfg() {
        document.getElementById("roulette-entry").value = String(
          rouletteCfg.entryCost ?? 0,
        );
        document.getElementById("roulette-clamp").checked = !!(
          rouletteCfg.clampNoNegative ?? true
        );
        const effectsEl = document.getElementById("roulette-effects");
        if (effectsEl) {
          effectsEl.checked = rouletteEffectsEnabled;
          effectsEl.addEventListener("change", () => {
            rouletteEffectsEnabled = !!effectsEl.checked;
          });
        }
        renderSegForm();
        // Update odds view when config loads
        setTimeout(renderOdds, 0);
      }
      function normalizeWeights() {
        if (!rouletteCfg?.segments?.length) return;
        const avg =
          rouletteCfg.segments.reduce(
            (a, b) => a + (Number(b.weight) || 1),
            0,
          ) / rouletteCfg.segments.length;
        rouletteCfg.segments = rouletteCfg.segments.map((s) => ({
          ...s,
          weight: Math.max(1, Math.round(s.weight / avg)) || 1,
        }));
        renderSegForm();
        drawRoulette();
      }

      // ---- Odds & Simulator ----
      function computeOdds(cfg) {
        const segs = (cfg?.segments || []).filter((s) => (s.weight || 0) > 0);
        const totalW = segs.reduce((a, s) => a + (Number(s.weight) || 0), 0);
        if (!segs.length || totalW <= 0) {
          return {
            pWin: 0,
            pLoss: 0,
            pZero: 0,
            evDelta: 0,
            probs: [],
          };
        }
        const probs = segs.map((s) => ({
          label: s.label || String(s.delta || 0),
          delta: Number(s.delta || 0),
          p: Number(s.weight || 0) / totalW,
          color: s.color || "#888",
        }));
        let pWin = 0,
          pLoss = 0,
          pZero = 0,
          evDelta = 0;
        for (const r of probs) {
          if (r.delta > 0) pWin += r.p;
          else if (r.delta < 0) pLoss += r.p;
          else pZero += r.p;
          evDelta += r.delta * r.p;
        }
        return { pWin, pLoss, pZero, evDelta, probs };
      }
      function renderOdds() {
        applySegFormToModel();
        const o = computeOdds(rouletteCfg);
        const fmtPct = (x) => (x * 100).toFixed(1) + "%";
        document.getElementById("stat-pwin").textContent = fmtPct(o.pWin);
        document.getElementById("stat-ploss").textContent = fmtPct(o.pLoss);
        document.getElementById("stat-pzero").textContent = fmtPct(o.pZero);
        const ev = Number(o.evDelta || 0);
        document.getElementById("stat-ev").textContent =
          (ev >= 0 ? "+" : "") + ev.toFixed(3);
        const entry = Number(
          document.getElementById("roulette-entry").value || 0,
        );
        const houseEdge = entry > 0 ? (-entry + ev) / entry : 0; // relative expected loss vs entry
        document.getElementById("stat-house").textContent =
          entry > 0 ? (houseEdge * 100).toFixed(1) + "%" : "--%";
        // Prob list
        const host = document.getElementById("prob-list");
        host.innerHTML = "";
        o.probs.forEach((r) => {
          const row = document.createElement("div");
          row.className = "prob-row";
          const bar = document.createElement("div");
          bar.className = "prob-bar";
          const span = document.createElement("span");
          span.style.width = Math.max(2, Math.round(r.p * 100)) + "%";
          span.style.background =
            r.delta > 0
              ? "linear-gradient(90deg,#37d28f,#2b9348)"
              : r.delta < 0
                ? "linear-gradient(90deg,#ff7b7b,#d90429)"
                : "linear-gradient(90deg,#6da8ff,#4361ee)";
          bar.append(span);
          const label = document.createElement("div");
          label.style.display = "flex";
          label.style.alignItems = "center";
          label.style.gap = "8px";
          const sw = document.createElement("span");
          sw.style.display = "inline-block";
          sw.style.width = "10px";
          sw.style.height = "10px";
          sw.style.borderRadius = "3px";
          sw.style.background = r.color;
          const txt = document.createElement("span");
          txt.textContent = `${"" + (r.label || r.delta)} (${(r.p * 100).toFixed(1)}%)`;
          label.append(sw, txt);
          row.append(label, bar);
          host.append(row);
        });
      }
      let simAbort = { flag: false };
      async function runSimulation() {
        applySegFormToModel();
        renderOdds();
        const trials = Math.max(
          1,
          parseInt(document.getElementById("sim-trials").value || "0", 10),
        );
        const steps = Math.max(
          1,
          parseInt(document.getElementById("sim-steps").value || "0", 10),
        );
        const bankroll0 = Math.max(
          0,
          parseInt(document.getElementById("sim-bankroll").value || "0", 10),
        );
        const entryOverrideRaw = document.getElementById("sim-entry").value;
        const entry =
          entryOverrideRaw === ""
            ? Number(rouletteCfg.entryCost || 0)
            : Math.max(0, Number(entryOverrideRaw || 0));
        const clamp = !!document.getElementById("roulette-clamp").checked;
        const probs = computeOdds(rouletteCfg).probs;
        if (!probs.length) return;
        const weights = probs.map((r) => r.p);
        const cum = [];
        let s = 0;
        for (const w of weights) {
          s += w;
          cum.push(s);
        }
        // Fast picker from cumulative probabilities
        function pick() {
          const r = Math.random();
          let i = 0;
          while (i < cum.length && r > cum[i]) i++;
          return probs[i] || probs[probs.length - 1];
        }
        const results = new Float64Array(trials);
        let busts = 0;
        const status = document.getElementById("sim-status");
        const btnRun = document.getElementById("sim-run");
        const btnStop = document.getElementById("sim-stop");
        btnRun.disabled = true;
        btnStop.disabled = false;
        simAbort.flag = false;
        status.textContent = `Running ${trials.toLocaleString()} trials × ${steps} spins…`;
        const batch = Math.max(50, Math.floor(trials / 40));
        for (let t = 0; t < trials; t += batch) {
          if (simAbort.flag) break;
          const end = Math.min(trials, t + batch);
          for (let i = t; i < end; i++) {
            let bal = bankroll0;
            for (let j = 0; j < steps; j++) {
              if (entry > bal && clamp) {
                // cannot pay entry
                // stop early if bankrupt
                break;
              }
              bal -= entry;
              const outcome = pick();
              bal += outcome.delta;
              if (clamp && bal < 0) bal = 0;
            }
            const profit = bal - bankroll0;
            results[i] = profit;
            if (bal === 0 && bankroll0 > 0) busts++;
          }
          if (t / trials < 1) {
            status.textContent = `Progress ${Math.min(100, Math.round((end / trials) * 100))}%…`;
            // Yield to UI
            await new Promise((r) => setTimeout(r, 0));
          }
        }
        btnRun.disabled = false;
        btnStop.disabled = true;
        if (simAbort.flag) {
          status.textContent = "Simulation canceled.";
          return;
        }
        // Summaries
        const arr = Array.from(results);
        arr.sort((a, b) => a - b);
        const n = arr.length;
        const p = (q) =>
          arr[Math.min(n - 1, Math.max(0, Math.floor(q * (n - 1))))];
        const median = p(0.5);
        const p95 = p(0.95);
        const p05 = p(0.05);
        const mean = arr.reduce((a, b) => a + b, 0) / Math.max(1, n);
        const bustPct = (busts / Math.max(1, trials)) * 100;
        document.getElementById("sim-med").textContent =
          (median >= 0 ? "+" : "") + median.toFixed(2);
        document.getElementById("sim-mean").textContent =
          (mean >= 0 ? "+" : "") + mean.toFixed(2);
        document.getElementById("sim-p95").textContent =
          (p95 >= 0 ? "+" : "") + p95.toFixed(2);
        document.getElementById("sim-p05").textContent =
          (p05 >= 0 ? "+" : "") + p05.toFixed(2);
        document.getElementById("sim-bust").textContent =
          bustPct.toFixed(1) + "%";
        status.textContent = `Done: ${trials.toLocaleString()} trials. Mean ${(mean >= 0 ? "+" : "") + mean.toFixed(2)} coins.`;
      }
      function stopSimulation() {
        simAbort.flag = true;
      }

      function pickWeightedIndex(weights) {
        const total = weights.reduce((a, b) => a + b, 0);
        let r = Math.random() * total;
        for (let i = 0; i < weights.length; i++) {
          r -= weights[i];
          if (r <= 0) return i;
        }
        return weights.length - 1;
      }
      function drawRoulette(spinAngle = 0) {
        const canvas = document.getElementById("roulette-canvas");
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        const { width, height } = canvas;
        ctx.clearRect(0, 0, width, height);
        const cx = width / 2;
        const cy = height / 2;
        const radius = Math.min(cx, cy) - 6;
        const segs = rouletteCfg.segments?.length ? rouletteCfg.segments : [];
        const totalWeight = segs.reduce((a, s) => a + (s.weight || 1), 0);
        let start = -Math.PI / 2 + spinAngle; // top
        segs.forEach((s) => {
          const frac = (s.weight || 1) / totalWeight;
          const sweep = frac * Math.PI * 2;
          ctx.beginPath();
          ctx.moveTo(cx, cy);
          ctx.arc(cx, cy, radius, start, start + sweep);
          ctx.closePath();
          ctx.fillStyle = s.color || "#888";
          ctx.fill();
          // text
          const mid = start + sweep / 2;
          ctx.save();
          ctx.translate(
            cx + Math.cos(mid) * (radius * 0.6),
            cy + Math.sin(mid) * (radius * 0.6),
          );
          ctx.rotate(mid + Math.PI / 2);
          ctx.fillStyle = "#fff";
          ctx.font = "bold 16px system-ui, -apple-system, Segoe UI, Roboto";
          ctx.textAlign = "center";
          ctx.fillText(s.label || String(s.delta), 0, 6);
          ctx.restore();
          start += sweep;
        });
        // pointer
        ctx.beginPath();
        ctx.moveTo(cx, cy - radius - 2);
        ctx.lineTo(cx - 10, cy - radius - 20);
        ctx.lineTo(cx + 10, cy - radius - 20);
        ctx.closePath();
        ctx.fillStyle = "#ffd166";
        ctx.fill();
      }
      async function loadRouletteConfig() {
        try {
          const db = getFirestore(app);
          const ref = doc(db, "config", "roulette");
          const snap = await getDoc(ref);
          rouletteCfg = snap.exists()
            ? { ...R_DEFAULT, ...snap.data() }
            : structuredClone(R_DEFAULT);
          fillFormFromCfg();
          drawRoulette();
          renderOdds();
        } catch (e) {
          console.warn("Failed to load roulette config", e);
          rouletteCfg = structuredClone(R_DEFAULT);
          fillFormFromCfg();
          drawRoulette();
          renderOdds();
        }
      }
      async function saveRouletteConfig(currentUser) {
        applySegFormToModel();
        // Minimal validation
        if (!rouletteCfg.segments?.length) {
          alert("Add at least one segment");
          return;
        }
        try {
          const db = getFirestore(app);
          const ref = doc(db, "config", "roulette");
          const payload = {
            ...rouletteCfg,
            updatedAt: serverTimestamp(),
            updatedBy: {
              uid: currentUser?.uid || null,
              name: currentUser?.displayName || null,
              email: currentUser?.email || null,
            },
          };
          await setDoc(ref, payload, { merge: true });
          alert("Saved roulette config");
        } catch (e) {
          alert("Save failed: " + e.message);
        }
      }
      function spinRoulette() {
        applySegFormToModel();
        const segs = rouletteCfg.segments || [];
        if (!segs.length) return;
        const spinBtn = document.getElementById("roulette-spin");
        const applyBtn = document.getElementById("roulette-apply");
        spinBtn?.setAttribute("disabled", "true");
        applyBtn?.setAttribute("disabled", "true");
        const badge = document.getElementById("roulette-result");
        if (badge) {
          badge.style.display = "none";
          badge.classList.remove("win", "loss", "pop");
        }
        const idx = pickWeightedIndex(
          segs.map((s) => Math.max(1, Number(s.weight || 1))),
        );
        const targetSeg = segs[idx];
        // Determine angle range of target segment (based on current draw function math)
        const totalWeight = segs.reduce((a, s) => a + (s.weight || 1), 0);
        let start = -Math.PI / 2; // starting reference for drawRoulette when spinAngle=0
        let accum = 0;
        for (let i = 0; i < idx; i++) accum += segs[i].weight || 1;
        const fracStart = accum / totalWeight;
        const fracMid = fracStart + (segs[idx].weight || 1) / totalWeight / 2;
        const midAngle = start + fracMid * Math.PI * 2;
        // We want pointer at top => rotate wheel so that midAngle aligns to top (-PI/2)
        const targetAngle = -Math.PI / 2 - midAngle; // delta angle to apply
        const canvas = document.getElementById("roulette-canvas");
        const duration = 2400 + Math.random() * 900; // 2.4-3.3s
        const extraTurns = 4 + Math.floor(Math.random() * 3); // 4-6 extra spins
        let startTs = null;
        let nextTickAt = 0;
        function easeOutCubic(t) {
          return 1 - Math.pow(1 - t, 3);
        }
        function step(ts) {
          if (!startTs) startTs = ts;
          const t = Math.min(1, (ts - startTs) / duration);
          const eased = easeOutCubic(t);
          const angle = eased * (extraTurns * Math.PI * 2 + targetAngle);
          drawRoulette(angle);
          if (ts >= nextTickAt) {
            const interval = 55 + 420 * t; // 55ms -> ~475ms
            playTick(1 - t);
            nextTickAt = ts + interval;
          }
          if (t < 1) requestAnimationFrame(step);
          else {
            rouletteSpinResult = { index: idx, segment: targetSeg };
            const isWin = Number(targetSeg.delta || 0) > 0;
            if (badge) {
              badge.style.display = "inline-flex";
              badge.textContent = `Result: ${targetSeg.label || targetSeg.delta}`;
              badge.classList.add(isWin ? "win" : "loss", "pop");
            }
            if (rouletteEffectsEnabled) {
              if (isWin) {
                playWin();
                fireConfetti({ count: 90 });
                flashCanvasWin();
              } else {
                playLose();
                shakeStage();
              }
            }
            spinBtn?.removeAttribute("disabled");
            applyBtn?.removeAttribute("disabled");
          }
        }
        requestAnimationFrame(step);
      }

      // Participants list
      async function loadRouletteUsers() {
        const tbody = document.getElementById("roulette-users-tbody");
        const status = document.getElementById("roulette-users-status");
        if (!tbody) return;
        tbody.innerHTML =
          '<tr><td colspan="5" style="text-align:center; opacity:.7;">Loading…</td></tr>';
        status.textContent = "Fetching users…";
        try {
          if (!currentIdToken) throw new Error("Not authed");
          const params = new URLSearchParams({
            limit: "200",
            order: "coins",
            dir: "desc",
          });
          const res = await fetch(
            `${apiBase}/admin/users?${params.toString()}`,
            {
              headers: { Authorization: `Bearer ${currentIdToken}` },
            },
          );
          const json = await res.json();
          if (!res.ok) throw new Error(json.error || "Request failed");
          const users = json.users || [];
          tbody.innerHTML = users
            .map((u) => {
              const name = u.displayName || "(no name)";
              const email = u.email || "";
              const coinsNum = Number(u.coins || 0);
              const coins = coinsNum.toLocaleString();
              const hour = u.hour ?? u.profile?.hour;
              return `<tr data-uid="${u.uid}" data-name="${(name || "").toLowerCase()}" data-email="${(email || "").toLowerCase()}" data-hour="${hour ?? ""}" data-coins="${coinsNum}">
                        <td><input type="checkbox" class="ru-check"></td>
                        <td>${name}</td>
                        <td>${email}</td>
                        <td class="num">${coins}</td>
                        <td class="num">${hour ?? ""}</td>
                      </tr>`;
            })
            .join("");
          status.textContent = `Loaded ${users.length} users`;
        } catch (e) {
          console.error(e);
          status.textContent = "Failed: " + e.message;
        }
      }

      // -----------------
      // Feedback (reviews)
      // -----------------
      let feedbackUnsub = null;
      let feedbackCache = [];
      function renderFeedbackList() {
        const q = (
          document.getElementById("feedback-search").value || ""
        ).toLowerCase();
        const cat = document.getElementById("feedback-filter").value;
        const stat = document.getElementById("feedback-status-filter").value;
        const tbody = document.getElementById("feedback-tbody");
        if (!tbody) return;
        const rows = [];
        feedbackCache.forEach((r) => {
          if (cat && r.category !== cat) return;
          if (stat && (r.status || "new") !== stat) return;
          const hay =
            `${r.subject || ""}\n${r.message || ""}\n${r.user?.email || ""}\n${r.user?.name || ""}`.toLowerCase();
          if (q && !hay.includes(q)) return;
          const ts = r?.createdAt && typeof r.createdAt.toDate === "function"
            ? r.createdAt.toDate()
            : (r?.createdAt?.seconds ? new Date(r.createdAt.seconds * 1000) : null);
          const when = ts ? ts.toLocaleString() : "--";
          const user = `${r.user?.name || "(anon)"}${r.user?.email ? `\n${r.user.email}` : ""}`;
          const rating = r.rating ? `★`.repeat(r.rating) : "-";
          const msg =
            (r.subject ? `<strong>${escapeHtml(r.subject)}</strong> — ` : "") +
            `${escapeHtml((r.message || "").slice(0, 240))}${(r.message || "").length > 240 ? "…" : ""}`;
          rows.push(`<tr data-id="${r.__id}">
            <td style="white-space:nowrap">${when}</td>
            <td>${escapeHtml(r.category || "")}</td>
            <td>${rating}</td>
            <td>${escapeHtml(user)}</td>
            <td>${msg}</td>
            <td>
              <select class="fb-status">
                ${["new", "reviewed", "closed", "spam"].map((s) => `<option value="${s}" ${s === (r.status || "new") ? "selected" : ""}>${s}</option>`).join("")}
              </select>
              <button class="btn-secondary btn-xs fb-view">View</button>
              <button class="btn-secondary btn-xs fb-del" title="Delete">🗑</button>
            </td>
          </tr>`);
        });
        tbody.innerHTML = rows.length
          ? rows.join("")
          : '<tr><td colspan="6" style="text-align:center; opacity:.7">No feedback</td></tr>';
        // Wire per-row actions
        tbody
          .querySelectorAll(".fb-view")
          .forEach((b) =>
            b.addEventListener("click", () =>
              openFeedbackModal(b.closest("tr").dataset.id),
            ),
          );
        tbody
          .querySelectorAll(".fb-del")
          .forEach((b) =>
            b.addEventListener("click", () =>
              deleteFeedback(b.closest("tr").dataset.id),
            ),
          );
        tbody
          .querySelectorAll(".fb-status")
          .forEach((sel) =>
            sel.addEventListener("change", (e) =>
              updateFeedbackStatus(sel.closest("tr").dataset.id, sel.value),
            ),
          );
      }
      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }
      function startFeedbackStream() {
        const status = document.getElementById("feedback-status");
        if (feedbackUnsub) return; // already streaming
        try {
          const db = getFirestore(app);
          const qRef = query(
            collection(db, "reviews"),
            orderBy("createdAt", "desc"),
            limit(200),
          );
          feedbackUnsub = onSnapshot(
            qRef,
            (snap) => {
              feedbackCache = snap.docs.map((d) => ({
                __id: d.id,
                ...d.data(),
              }));
              renderFeedbackList();
              status.textContent = `Loaded ${feedbackCache.length} items`;
            },
            (err) => {
              console.error(err);
              status.textContent = "Error loading feedback: " + err.message;
            },
          );
        } catch (e) {
          console.error(e);
          document.getElementById("feedback-status").textContent =
            "Failed to start stream.";
        }
        // Filters
        document
          .getElementById("feedback-search")
          .addEventListener("input", renderFeedbackList);
        document
          .getElementById("feedback-filter")
          .addEventListener("change", renderFeedbackList);
        document
          .getElementById("feedback-status-filter")
          .addEventListener("change", renderFeedbackList);
      }
      async function updateFeedbackStatus(id, status) {
        try {
          const db = getFirestore(app);
          await updateDoc(doc(db, "reviews", id), { status });
        } catch (e) {
          alert("Failed to update: " + e.message);
        }
      }
      async function deleteFeedback(id) {
        if (!confirm("Delete this feedback? This cannot be undone.")) return;
        try {
          const db = getFirestore(app);
          await deleteDoc(doc(db, "reviews", id));
        } catch (e) {
          alert("Delete failed: " + e.message);
        }
      }
      function openFeedbackModal(id) {
        const r = feedbackCache.find((x) => x.__id === id);
        if (!r) return;
        const div = document.createElement("div");
        const ts = r?.createdAt && typeof r.createdAt.toDate === "function"
          ? r.createdAt.toDate().toLocaleString()
          : (r?.createdAt?.seconds ? new Date(r.createdAt.seconds * 1000).toLocaleString() : "--");
        div.innerHTML = `
          <div class="notice" style="margin-bottom:10px"><strong>Submitted:</strong> ${ts}</div>
          <p><strong>User:</strong> ${escapeHtml(r.user?.name || "(anon)")}${r.user?.email ? ` &lt;${escapeHtml(r.user.email)}&gt;` : ""}</p>
          <p><strong>Category:</strong> ${escapeHtml(r.category || "")}</p>
          <p><strong>Rating:</strong> ${r.rating ? `${"★".repeat(r.rating)} (${r.rating}/5)` : "-"}</p>
          ${r.subject ? `<p><strong>Subject:</strong> ${escapeHtml(r.subject)}</p>` : ""}
          <div style="white-space: pre-wrap; word-break: break-word; border:1px solid #30343a; padding:10px; border-radius:10px; background:#23262b; margin-top:8px;">
            ${escapeHtml(r.message || "")}
          </div>
          ${r.contact ? `<p style="margin-top:8px"><strong>Contact:</strong> ${escapeHtml(r.contact)}</p>` : ""}
        `;
        createModal({
          title: "Feedback Details",
          body: div,
          actions: [{ label: "Close" }],
        });
      }
      function filterRouletteUsers() {
        const q = document
          .getElementById("roulette-search")
          .value.toLowerCase();
        const hour = document.getElementById("roulette-hour").value;
        const rows = document.querySelectorAll("#roulette-users-tbody tr");
        rows.forEach((r) => {
          const nm = r.dataset.name || "";
          const em = r.dataset.email || "";
          const hr = String(r.dataset.hour || "");
          let ok = nm.includes(q) || em.includes(q);
          if (hour) {
            if (hour === "none") ok = ok && (hr === "" || hr === "undefined");
            else ok = ok && hr === hour;
          }
          r.style.display = ok ? "" : "none";
        });
      }
      function getSelectedUserIds() {
        const rows = document.querySelectorAll("#roulette-users-tbody tr");
        const ids = [];
        rows.forEach((r) => {
          const cb = r.querySelector(".ru-check");
          if (cb && cb.checked && r.style.display !== "none")
            ids.push(r.dataset.uid);
        });
        return ids;
      }
      function selectAllRouletteUsers(val) {
        document
          .querySelectorAll("#roulette-users-tbody .ru-check")
          .forEach((cb) => (cb.checked = val));
      }

      async function applyRouletteResult() {
        if (!rouletteSpinResult) {
          alert("Spin first to get a result.");
          return;
        }
        const ids = getSelectedUserIds();
        if (!ids.length) {
          alert("Select at least one participant.");
          return;
        }
        // Confirm summary
        const seg = rouletteSpinResult.segment;
        const entry = Number(
          document.getElementById("roulette-entry").value || 0,
        );
        const clamp = !!document.getElementById("roulette-clamp").checked;
        if (
          !confirm(
            `Apply result \"${seg.label || seg.delta}\" (delta ${seg.delta >= 0 ? "+" : ""}${seg.delta} coins) to ${ids.length} students? Entry cost ${entry}.`,
          )
        )
          return;
        // Apply per-user using existing admin API
        const statusEl = document.getElementById("roulette-users-status");
        let ok = 0,
          fail = 0;
        for (const uid of ids) {
          try {
            // Get current coins from the table dataset
            const row = document.querySelector(
              `#roulette-users-tbody tr[data-uid="${uid}"]`,
            );
            let coins = Number(row?.dataset.coins || 0);
            let next = coins - entry + Number(seg.delta || 0);
            if (clamp && next < 0) next = 0;
            const patch = await fetch(`${apiBase}/admin/users/${uid}`, {
              method: "PATCH",
              headers: {
                Authorization: `Bearer ${currentIdToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ coins: Math.floor(next) }),
            });
            const pj = await patch.json();
            if (!patch.ok) throw new Error(pj.error || "Patch failed");
            ok++;
            statusEl.textContent = `Updated ${ok}/${ids.length}…`;
            // Update row display and dataset
            if (row) {
              row.dataset.coins = String(Math.floor(next));
              const cell = row.querySelector("td:nth-child(4)");
              if (cell) cell.textContent = Number(next).toLocaleString();
            }
          } catch (e) {
            console.error("Apply failed for", uid, e);
            fail++;
          }
        }
        statusEl.textContent = `Done. Success: ${ok}, Failed: ${fail}`;
        // Refresh other panels if visible
        loadUsers();
        loadStats();
      }

      // Bind Roulette UI events
      document
        .getElementById("roulette-load")
        ?.addEventListener("click", loadRouletteConfig);
      document
        .getElementById("roulette-save")
        ?.addEventListener("click", () => saveRouletteConfig(auth.currentUser));
      document
        .getElementById("roulette-reset")
        ?.addEventListener("click", () => {
          rouletteCfg = structuredClone(R_DEFAULT);
          fillFormFromCfg();
          drawRoulette();
        });
      document.getElementById("segment-add")?.addEventListener("click", () => {
        rouletteCfg.segments.push({
          label: "+1",
          delta: 1,
          color: "#4cc9f0",
          weight: 1,
        });
        renderSegForm();
        drawRoulette();
        renderOdds();
      });
      document
        .getElementById("segment-balance")
        ?.addEventListener("click", () => {
          normalizeWeights();
          renderOdds();
        });
      document
        .getElementById("roulette-spin")
        ?.addEventListener("click", spinRoulette);
      document
        .getElementById("roulette-apply")
        ?.addEventListener("click", applyRouletteResult);

      // Odds recompute on entry/clamp changes
      document
        .getElementById("roulette-entry")
        ?.addEventListener("input", renderOdds);
      document
        .getElementById("roulette-clamp")
        ?.addEventListener("change", renderOdds);

      // Simulator controls
      document
        .getElementById("sim-run")
        ?.addEventListener("click", runSimulation);
      document
        .getElementById("sim-stop")
        ?.addEventListener("click", stopSimulation);
      document
        .getElementById("roulette-search")
        ?.addEventListener("input", filterRouletteUsers);
      document
        .getElementById("roulette-hour")
        ?.addEventListener("change", filterRouletteUsers);
      document
        .getElementById("roulette-reload")
        ?.addEventListener("click", loadRouletteUsers);
      document
        .getElementById("select-all")
        ?.addEventListener("click", () => selectAllRouletteUsers(true));
      document
        .getElementById("select-none")
        ?.addEventListener("click", () => selectAllRouletteUsers(false));

      // Data loaders
      async function loadStats() {
        const status = document.getElementById("stats-status");
        status.textContent = "Loading stats…";
        try {
          const [gRes, uRes] = await Promise.all([
            fetch(`${apiBase}/stats/moorecoins/total`),
            fetch(`${apiBase}/stats/users/total`),
          ]);
          const gJson = await gRes.json();
          const uJson = await uRes.json();
          const totalCoins = Number(gJson.moorecoins || 0);
          const totalUsers = Number(uJson.total || 0);
          document.getElementById("stat-global-coins").textContent =
            totalCoins.toLocaleString();
          document.getElementById("stat-total-users").textContent =
            totalUsers.toLocaleString();
          document.getElementById("stat-exchange").textContent =
            calculateExchangeRate(totalCoins).toFixed(3);
          document.getElementById("stat-interest").textContent =
            ((1 + calculateInterestRate(totalCoins)) * 100).toFixed(2) + "%";
          status.textContent = "";
        } catch (e) {
          console.error(e);
          status.textContent = "Failed to load stats";
        }
      }

      let currentSortField = "coins";
      let currentSortDir = "desc";

      async function loadPending() {
        const tbody = document.getElementById("pending-tbody");
        const status = document.getElementById("pending-status");
        if (!tbody) return; // panel not present
        tbody.innerHTML =
          '<tr><td colspan="4" style="text-align:center; opacity:.7;">Loading…</td></tr>';
        status.textContent = "Fetching pending…";
        try {
          if (!currentIdToken) throw new Error("Not authed");
          const res = await fetch(`${apiBase}/admin/pending`, {
            headers: { Authorization: `Bearer ${currentIdToken}` },
          });
          const json = await res.json();
          if (!res.ok) throw new Error(json.error || "Request failed");
          const list = json.pending || [];
          if (!list.length) {
            tbody.innerHTML =
              '<tr><td colspan="4" style="text-align:center; opacity:.6;">No pending transactions</td></tr>';
            status.textContent = "None";
            return;
          }
          const totalCoins = list.reduce((a, b) => a + (b.amount || 0), 0);
          status.textContent = `${list.length} pending • ${totalCoins.toLocaleString()} coins total`;
          tbody.innerHTML = list
            .map((p) => {
              const name = p.displayName || "(no name)";
              const email = p.email
                ? `<a href="https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(p.email)}" target="_blank" rel="noopener" class="email-link">${p.email}</a>`
                : "";
              return `<tr data-uid="${p.uid}"><td>${name}</td><td>${email}</td><td class="num">${Number(p.amount || 0).toLocaleString()}</td><td style="display:flex; gap:6px; flex-wrap:wrap;">
                        <button class="btn-secondary btn-xs" data-action="view" title="View extra credit">View</button>
                        <button class="btn-secondary btn-xs" data-action="copy" title="Copy extra credit value">Copy</button>
                        <button class="btn-secondary btn-xs" data-action="clear" title="Clear from pending" style="background:#3a1f1f; border-color:#5a2b2b;">Clear</button>
                    </td></tr>`;
            })
            .join("");
        } catch (e) {
          console.error(e);
          status.textContent = "Failed: " + e.message;
        }
      }

      document
        .getElementById("btn-reload-pending")
        ?.addEventListener("click", loadPending);

      // Delegate actions in pending table
      document.addEventListener("click", async (e) => {
        const btn = e.target.closest("#pending-table button[data-action]");
        if (!btn) return;
        const tr = btn.closest("tr");
        const uid = tr?.dataset.uid;
        if (!uid) return;
        const amountCell = tr.querySelector("td:nth-child(3)");
        const coins =
          parseInt((amountCell?.textContent || "").replace(/[,]/g, "")) || 0;
        const exchangeRate =
          Number(document.getElementById("stat-exchange")?.textContent) || 0; // Already loaded approximated
        const action = btn.dataset.action;
        if (action === "view") {
          const extra = (coins * exchangeRate).toFixed(2);
          createModal({
            title: "Extra Credit Preview",
            body: `<p>${coins.toLocaleString()} coins at current rate (${exchangeRate.toFixed(3)}) ≈ <strong>${extra}</strong> extra credit points.</p><p style='font-size:.8rem; opacity:.7;'>Rate is dynamic; snapshot this before entering gradebook.</p>`,
          });
        } else if (action === "copy") {
          const extra = (coins * exchangeRate).toFixed(2);
          try {
            await navigator.clipboard.writeText(extra);
            btn.textContent = "Copied";
            setTimeout(() => (btn.textContent = "Copy"), 1800);
          } catch {
            btn.textContent = "Err";
            setTimeout(() => (btn.textContent = "Copy"), 1800);
          }
        } else if (action === "clear") {
          if (!confirm("Remove this pending entry?")) return;
          btn.disabled = true;
          btn.textContent = "…";
          try {
            const resp = await fetch(`${apiBase}/admin/pending/${uid}`, {
              method: "DELETE",
              headers: { Authorization: `Bearer ${currentIdToken}` },
            });
            const json = await resp.json();
            if (!resp.ok) throw new Error(json.error || "Failed");
            tr.remove();
            // Update status counts
            loadPending();
          } catch (err) {
            console.error(err);
            btn.textContent = "Err";
            setTimeout(() => (btn.textContent = "Clear"), 1600);
            btn.disabled = false;
          }
        }
      });

      async function loadUsers() {
        const tbody = document.getElementById("users-tbody");
        const status = document.getElementById("users-status");
        tbody.innerHTML =
          '<tr><td colspan="7" style="text-align:center; opacity:.7;">Loading…</td></tr>';
        status.textContent = "Fetching users…";
        try {
          if (!currentIdToken) throw new Error("Not authed");
          const params = new URLSearchParams({
            limit: "200",
            order: currentSortField,
            dir: currentSortDir,
          });
          const res = await fetch(
            `${apiBase}/admin/users?${params.toString()}`,
            { headers: { Authorization: `Bearer ${currentIdToken}` } },
          );
          const json = await res.json();
          if (!res.ok) throw new Error(json.error || "Request failed");
          const users = json.users || [];
          status.textContent = `Loaded ${users.length} users`;
          tbody.innerHTML = users
            .map(
              (
                u,
              ) => `<tr data-uid="${u.uid}" class="user-row" tabindex="0" title="Click to edit">
						<td><img data-avatar="1" data-src="${u.photoURL || ""}" alt="" class="avatar-sm" /></td>
						<td>${u.displayName || "(no name)"}</td>
                        <td>${u.email ? `<a href="https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(u.email)}" target="_blank" rel="noopener" class="email-link" draggable="false" data-email="${u.email}">${u.email}</a>` : ""}</td>
						<td class="num">${Number(u.coins || 0).toLocaleString()}</td>
						<td class="num">${u.totalEarned !== undefined ? Number(u.totalEarned || 0).toLocaleString() : "—"}</td>
						<td class="num">${u.hour !== undefined && u.hour !== null ? u.hour : ""}</td>
						<td>${u.admin ? '<span class="chip chip-admin">ADMIN</span>' : ""}</td>
					</tr>`,
            )
            .join("");
          // Apply avatar loading with fallback
          [...tbody.querySelectorAll("img[data-avatar]")].forEach((img) => {
            const src = img.getAttribute("data-src");
            safeSetAvatar(img, src);
          });
          // Ensure Gmail links have properly encoded email
          tbody.querySelectorAll("a.email-link[data-email]").forEach((a) => {
            const em = a.getAttribute("data-email");
            if (em) {
              a.href = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(em)}`;
            }
          });
          // Row click to edit
          tbody.querySelectorAll("tr.user-row").forEach((row) => {
            row.addEventListener("click", (e) => {
              if (e.target.closest("a.email-link")) return; // allow mailto
              openEditUser(row.dataset.uid, row);
            });
            row.addEventListener("keydown", (e) => {
              if (e.target.closest("a.email-link")) return; // don't hijack link keyboard
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                openEditUser(row.dataset.uid, row);
              }
            });
          });
        } catch (e) {
          console.error(e);
          status.textContent = "Failed: " + e.message;
        }
      }

      // Search filter
      document.getElementById("user-search").addEventListener("input", (e) => {
        const q = e.target.value.toLowerCase();
        const rows = document.querySelectorAll("#users-tbody tr");
        rows.forEach((r) => {
          const text = r.textContent.toLowerCase();
          r.style.display = text.includes(q) ? "" : "none";
        });
      });

      document
        .getElementById("btn-reload-users")
        .addEventListener("click", loadUsers);
      document
        .getElementById("btn-refresh-stats")
        .addEventListener("click", loadStats);
      document.getElementById("user-sort").addEventListener("change", (e) => {
        currentSortField = e.target.value;
        loadUsers();
      });
      document.getElementById("btn-sort-dir").addEventListener("click", (e) => {
        currentSortDir =
          e.currentTarget.dataset.dir === "desc" ? "asc" : "desc";
        e.currentTarget.dataset.dir = currentSortDir;
        e.currentTarget.textContent =
          currentSortDir === "desc" ? "Desc ↓" : "Asc ↑";
        loadUsers();
      });
      document
        .getElementById("btn-hour-award")
        .addEventListener("click", () => openHourAward());

      function openHourAward() {
        const wrap = document.createElement("div");
        wrap.innerHTML = `
                <form id="hour-award-form" autocomplete="off">
                    <div class="form-row">
                        <label for="award-hour">Hour (1-6)</label>
                        <input id="award-hour" type="number" min="1" max="6" placeholder="e.g. 3" style="width:100%; background:#23262b; border:1px solid #30343a; padding:10px 12px; border-radius:10px; color:#f2f6fa;" required />
                    </div>
                    <div class="form-row">
                        <label for="award-coins">Coins per user</label>
                        <input id="award-coins" type="number" min="1" step="1" placeholder="50" style="width:100%; background:#23262b; border:1px solid #30343a; padding:10px 12px; border-radius:10px; color:#f2f6fa;" required />
                    </div>
                    <div class="inline-info">Adds coins to every student whose profile hour matches. Irreversible.</div>
                    <div id="hour-award-status" class="inline-info" style="margin-top:8px; min-height:14px;"></div>
                </form>`;
        const hourInput = wrap.querySelector("#award-hour");
        const coinsInput = wrap.querySelector("#award-coins");
        const status = wrap.querySelector("#hour-award-status");
        createModal({
          title: "Award Coins To Hour",
          body: wrap,
          initialFocus: "#award-hour",
          actions: [
            { label: "Cancel" },
            {
              label: "Award",
              primary: true,
              onClick: async () => {
                const h = parseInt(hourInput.value, 10);
                const c = parseInt(coinsInput.value, 10);
                if (isNaN(h) || h < 1 || h > 6) {
                  status.textContent = "Hour must be 1-6";
                  return false;
                }
                if (isNaN(c) || c < 1) {
                  status.textContent = "Coins must be > 0";
                  return false;
                }
                status.textContent = "Processing…";
                try {
                  const resp = await fetch(`${apiBase}/admin/hour/award`, {
                    method: "POST",
                    headers: {
                      Authorization: `Bearer ${currentIdToken}`,
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ hour: h, coins: c }),
                  });
                  const json = await resp.json();
                  if (!resp.ok) {
                    status.textContent = json.error || "Failed";
                    return false;
                  }
                  status.textContent = `Awarded ${json.coinsPerUser} to ${json.userCount} users (total ${json.totalAwarded}).`;
                  loadUsers();
                  loadStats();
                } catch (e) {
                  status.textContent = "Network error";
                  return false;
                }
              },
            },
          ],
        });
      }

      async function openEditUser(uid, rowEl) {
        if (!uid) return;
        const coinsCell = rowEl?.querySelector("td:nth-child(4)");
        const earnedCell = rowEl?.querySelector("td:nth-child(5)");
        const hourCell = rowEl?.querySelector("td:nth-child(6)");
        const adminCell = rowEl?.querySelector("td:nth-child(7)");
        const currentCoins = coinsCell
          ? parseInt(coinsCell.textContent.replace(/[,]/g, ""))
          : 0;
        const currentHour = hourCell ? hourCell.textContent.trim() || "" : "";
        const isAdmin = !!adminCell?.querySelector(".chip-admin");
        const wrap = document.createElement("div");
        wrap.innerHTML = `
                <form id="edit-user-form" autocomplete="off">
                    <div class="form-row">
                        <label for="edit-coins">Coins</label>
                        <input id="edit-coins" type="number" step="1" value="${currentCoins}" style="width:100%; background:#23262b; border:1px solid #30343a; padding:10px 12px; border-radius:10px; color:#f2f6fa;" />
                    </div>
                    <div class="form-row">
                        <label for="edit-hour">Hour (class period)</label>
                        <input id="edit-hour" type="number" min="0" max="24" value="${currentHour}" placeholder="e.g. 3" style="width:100%; background:#23262b; border:1px solid #30343a; padding:10px 12px; border-radius:10px; color:#f2f6fa;" />
                        <div class="inline-info">Leave blank to clear.</div>
                    </div>
                    <div class="form-row" style="margin-top:12px; display:flex; align-items:center; gap:8px;">
                        <input id="edit-admin" type="checkbox" ${isAdmin ? "checked" : ""} /> <label for="edit-admin" style="margin:0;">Admin</label>
                    </div>
                    <div id="edit-user-status" class="inline-info" style="margin-top:10px;"></div>
                </form>`;
        const coinsInput = wrap.querySelector("#edit-coins");
        const hourInput = wrap.querySelector("#edit-hour");
        const adminInput = wrap.querySelector("#edit-admin");
        const status = wrap.querySelector("#edit-user-status");
        createModal({
          title: `Edit User ${uid.substring(0, 6)}…`,
          body: wrap,
          initialFocus: "#edit-coins",
          actions: [
            { label: "Cancel" },
            {
              label: "Save",
              primary: true,
              onClick: async () => {
                const newCoins = parseInt(coinsInput.value);
                if (isNaN(newCoins)) {
                  status.textContent = "Enter valid coins";
                  return false;
                }
                const hourVal = hourInput.value.trim();
                let hourParsed = null;
                if (hourVal !== "") {
                  const parsed = parseInt(hourVal, 10);
                  if (isNaN(parsed)) {
                    status.textContent = "Hour must be number";
                    return false;
                  }
                  hourParsed = parsed;
                }
                const newAdmin = adminInput.checked;
                status.textContent = "Saving…";
                try {
                  const body = { coins: newCoins, admin: newAdmin };
                  if (hourVal === "") body.hour = "";
                  else body.hour = hourParsed;
                  const res = await fetch(`${apiBase}/admin/users/${uid}`, {
                    method: "PATCH",
                    headers: {
                      Authorization: `Bearer ${currentIdToken}`,
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify(body),
                  });
                  const json = await res.json();
                  console.log(res, json);
                  if (!res.ok) throw new Error(json.error || "Failed");
                  status.textContent = "Updated";
                  // Update row inline without reload for snappy UX
                  if (coinsCell)
                    coinsCell.textContent = Number(
                      json.coins || 0,
                    ).toLocaleString();
                  if (hourCell)
                    hourCell.textContent =
                      json.hour !== undefined && json.hour !== null
                        ? json.hour
                        : "";
                  if (adminCell)
                    adminCell.innerHTML = json.admin
                      ? '<span class="chip chip-admin">ADMIN</span>'
                      : "";
                  loadStats(); // reflect global change if delta
                } catch (e) {
                  status.textContent = "Error: " + e.message;
                  return false;
                }
              },
            },
          ],
        });
      }

      // Adjust global coins modal
      document
        .getElementById("btn-adjust-global")
        .addEventListener("click", () => {
          const wrap = document.createElement("div");
          wrap.innerHTML = `
				<form id="adj-form" autocomplete="off">
					<div class="form-row">
						<label for="delta">Add/Subtract Coins</label>
						<input id="delta" type="number" step="1" placeholder="100" style="width:100%; background:#23262b; border:1px solid #30343a; padding:10px 12px; border-radius:10px; color:#f2f6fa;" />
						<div class="inline-info">Use negative number to subtract.</div>
					</div>
					<div id="adj-status" class="inline-info"></div>
				</form>`;
          const delta = wrap.querySelector("#delta");
          const status = wrap.querySelector("#adj-status");
          createModal({
            title: "Adjust Global Moorecoins",
            body: wrap,
            initialFocus: "#delta",
            actions: [
              { label: "Cancel" },
              {
                label: "Apply Change",
                primary: true,
                onClick: async ({ close }) => {
                  const val = Number(delta.value);
                  if (!val) {
                    status.textContent = "Enter a non-zero integer";
                    return false;
                  }
                  status.textContent = "Applying…";
                  try {
                    const res = await fetch(
                      `${apiBase}/stats/moorecoins/edit`,
                      {
                        method: "POST",
                        headers: {
                          Authorization: `Bearer ${currentIdToken}`,
                          "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ moorecoins: val }),
                      },
                    );
                    const json = await res.json();
                    if (!res.ok) throw new Error(json.error || "Failed");
                    status.textContent =
                      "Success. New total: " + json.moorecoins;
                    loadStats();
                  } catch (e) {
                    status.textContent = "Error: " + e.message;
                    return false;
                  }
                },
              },
            ],
          });
        });

      // Auth & profile
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "./index.html";
          return;
        }
        try {
          currentIdToken = await user.getIdToken();
        } catch (e) {
          console.error(e);
        }
        // Verify admin via user doc
        try {
          const infoRes = await fetch(`${apiBase}/user/info`, {
            headers: { Authorization: `Bearer ${currentIdToken}` },
          });
          const info = await infoRes.json();
          const isAdmin = info?.flags?.admin || info?.admin;
          if (!isAdmin) {
            window.location.href = "./dashboard.html";
            return;
          }
          // Populate profile from richer info if available
          safeSetAvatar(
            document.getElementById("profile-pic"),
            info.profile?.photoURL || user.photoURL,
          );
          safeSetAvatar(
            document.getElementById("profile-menu-avatar"),
            info.profile?.photoURL || user.photoURL,
          );
          document.getElementById("profile-menu-name").textContent =
            info.profile?.displayName || user.displayName || "Admin";
          document.getElementById("profile-menu-email").textContent =
            info.profile?.email || user.email || "";
          // Initialize Site Banner editor
          try {
            setupBannerAdmin(user);
          } catch (e) {
            console.warn(e);
          }
        } catch (e) {
          console.error("Admin check failed", e);
          window.location.href = "./dashboard.html";
          return;
        }
        await loadStats();
        await loadUsers();
        // Preload pending in background (non-blocking)
        loadPending();
      });

      // dropdown menu reuse
      const profilePic = document.getElementById("profile-pic");
      const menu = document.getElementById("profile-menu");
      profilePic.addEventListener("click", (e) => {
        e.stopPropagation();
        const hidden = menu.classList.contains("hidden");
        menu.classList.toggle("hidden", !hidden);
        menu.setAttribute("aria-hidden", String(!hidden));
        if (!hidden) {
          return;
        }
        const rect = profilePic.getBoundingClientRect();
        menu.style.top = `${rect.bottom + window.scrollY + 8}px`;
        menu.style.right = `${window.innerWidth - rect.right - window.scrollX}px`;
      });
      document.addEventListener("click", (e) => {
        if (
          !menu.classList.contains("hidden") &&
          !menu.contains(e.target) &&
          e.target !== profilePic
        ) {
          menu.classList.add("hidden");
          menu.setAttribute("aria-hidden", "true");
        }
      });
      document
        .getElementById("sign-out")
        .addEventListener("click", async () => {
          try {
            await auth.signOut();
            window.location.href = "./index.html";
          } catch (e) {
            console.error(e);
          }
        });
      document.getElementById("go-dashboard").addEventListener("click", () => {
        window.location.href = "./dashboard.html";
      });

      // -----------------------
      // Site Banner Admin Logic
      // -----------------------
      function setupBannerAdmin(currentUser) {
        const db = getFirestore(app);
        const ref = doc(db, "config", "banner");
        const els = {
          msg: document.getElementById("banner-msg"),
          link: document.getElementById("banner-link"),
          variant: document.getElementById("banner-variant"),
          active: document.getElementById("banner-active"),
          dismissible: document.getElementById("banner-dismissible"),
          save: document.getElementById("banner-save"),
          preview: document.getElementById("banner-preview"),
          deactivate: document.getElementById("banner-deactivate"),
          reset: document.getElementById("banner-reset"),
          status: document.getElementById("banner-status"),
          area: document.getElementById("banner-preview-area"),
        };
        if (!els.msg) return; // panel not present
        let current = null;
        let isSaving = false;
        onSnapshot(ref, (snap) => {
          current = snap.exists() ? snap.data() : null;
          if (isSaving) return; // don't clobber user input while saving
          if (current) fillForm(current);
        });
        function fillForm(data) {
          els.msg.value = data.message || "";
          els.link.value = data.linkUrl || "";
          els.variant.value = (data.variant || "promo").toLowerCase();
          els.active.checked = data.active !== false;
          els.dismissible.checked = data.dismissible !== false;
        }
        function collect() {
          return {
            message: els.msg.value.trim(),
            linkUrl: els.link.value.trim() || "",
            variant: els.variant.value,
            active: !!els.active.checked,
            dismissible: !!els.dismissible.checked,
          };
        }
        function renderPreview() {
          const data = collect();
          const box = document.createElement("div");
          box.className = `site-banner banner-${(data.variant || "promo").toLowerCase()}`;
          const inner = document.createElement("div");
          inner.className = "site-banner-inner";
          const span = document.createElement("span");
          span.textContent = data.message || "(empty)";
          if (data.linkUrl) {
            const a = document.createElement("a");
            a.href = data.linkUrl;
            a.target = "_blank";
            a.rel = "noopener";
            a.textContent = "Learn more";
            span.append(" ");
            span.append(a);
          }
          inner.append(span);
          box.append(inner);
          els.area.innerHTML = "";
          els.area.append(box);
        }
        async function save() {
          const data = collect();
          if (!data.message) {
            els.status.textContent = "Message is required";
            return;
          }
          try {
            isSaving = true;
            els.status.textContent = "Saving…";
            const version = (current?.version ?? 0) + 1;
            const payload = {
              ...data,
              version: data.active ? version : (current?.version ?? 1),
              updatedAt: serverTimestamp(),
              updatedBy: {
                uid: currentUser?.uid || null,
                name: currentUser?.displayName || null,
                email: currentUser?.email || null,
              },
            };
            await setDoc(ref, payload, { merge: true });
            els.status.textContent = "Saved";
          } catch (e) {
            console.error(e);
            els.status.textContent = "Save failed: " + e.message;
          } finally {
            isSaving = false;
          }
        }
        async function deactivate() {
          try {
            isSaving = true;
            els.status.textContent = "Deactivating…";
            await setDoc(
              ref,
              { active: false, updatedAt: serverTimestamp() },
              { merge: true },
            );
            els.status.textContent = "Deactivated";
          } catch (e) {
            els.status.textContent = "Error: " + e.message;
          } finally {
            isSaving = false;
          }
        }
        function resetDismiss() {
          try {
            const prefix = "moorecoin_banner_dismiss_v";
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
              const k = localStorage.key(i);
              if (k && k.startsWith(prefix)) keys.push(k);
            }
            keys.forEach((k) => localStorage.removeItem(k));
            els.status.textContent = "Local dismiss reset";
          } catch {}
        }
        els.preview.addEventListener("click", renderPreview);
        els.save.addEventListener("click", save);
        els.deactivate.addEventListener("click", deactivate);
        els.reset.addEventListener("click", resetDismiss);
        // Initial populate
        getDoc(ref).then((snap) => snap.exists() && fillForm(snap.data()));
      }
    </script>
    <script type="module" src="./banner.js"></script>
    <script src="./easter-eggs.js"></script>
  </body>
</html>
